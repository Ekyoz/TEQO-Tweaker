"use strict";var e=require("events"),t=require("https"),n=require("dgram"),o=require("os"),r=require("crypto");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=i(e),s=i(t),c=i(n),u=i(o),l=i(r);function f(e){return new Promise(((t,n)=>{const o=s.default.request({method:e.method,path:e.path,hostname:"api.electrolytic.app",headers:e.headers},(e=>{if(200!==e.statusCode)return n(e);e.on("data",(e=>{t(JSON.parse(e))}))}));o.on("error",(e=>{n(e)})),e.data&&o.write(e.data),o.end()}))}var d=e=>f({headers:{},method:"GET",path:e.path}),p=e=>{const t=JSON.stringify(e.data);return f({path:e.path,data:t,method:"POST",headers:{"Content-Type":"application/json","Content-Length":t.length}})},m=function(e){return p({path:"/client/auth",data:e})},h=function(e,t){return d({path:`/config/get?appKey=${e}&configId=${t||"all"}`})},g=function(e){return p({path:"/analytics/report",data:e})};var y=function(e=""){const t=["Electrolytic",e].join(":");return{log:(...e)=>console.log(`${t}:`,...e),warn:(...e)=>console.log(`${t}:`,"Warning:",...e),error:(...e)=>console.error(`${t}:`,"Error:",...e)}};var C=function(){const e={},t=c.default.createSocket("udp4");let n=()=>{},o=()=>{};return e.address=()=>t.address(),e.send=function(e,n,o){t.send(Buffer.from(e),n.port,n.ip,o)},e.close=function(){t.close()},e.onInit=function(e){o=e},e.onMessage=function(e){n=e},t.on("message",(function(e,t){n(e.toString(),t)})),e.bind=function(e){t.on("listening",o),t.bind(e),t.on("error",(function(e){console.log("error in socket",e)})),console.log("bind",e)},e};var v={timers:{ACK:3e3},MSG_TYPES:{OPEN:2,PING:3,ACK:1,PUSH:4,AUT:5,CLOSE:0}};const P=v.MSG_TYPES;function S(e=4){return Math.random().toString(36).substr(2,e)}var T=function(e=1){const t={};function n({type:e,payload:n,id:o}){return t.encode({type:e,payload:n,id:o})}return t.encode=function(t,n){let o=[e,t.type,t.id];if(t.payload){let e=JSON.stringify(t.payload);o.push((r=e,Buffer.from(r).toString("base64")))}var r;return o.join(":")},t.decode=function(e,t){let[n,o,r,i]=e.split(":");if(!n||!o)return!1;let a={id:r,type:parseInt(o)};if(i)try{a.payload=JSON.parse((s=i,Buffer.from(s,"base64").toString()))}catch(e){return console.log("messageManager:decode:error",e),!1}var s;return a},t.acknowledgement=function(e){return n({type:P.ACK,id:e.id})},t.create=function(e,t){return n({type:e,payload:t,id:S()})},t.parse=function(e){return new Promise(((t,n)=>{let o=this.decode(e);!1===o?n("Malformed message. Discarding."):t(o)}))},t};const{timers:A,MSG_TYPES:b}=v;const E=function(e){const t={},{messageManager:n,socket:o}=e,r=[],i=[];let a=()=>{},s=()=>{},c=()=>{};function u(e){delete r[e],delete i[e]}function l(e,t,a=!1){return new Promise(((s,c)=>{o.send(e,t,(t=>{if(t)return c(t);a?n.parse(e).then((e=>{i[e.id]=t=>{s(),u(e.id)},r[e.id]=setTimeout((()=>{u(e.id),c("Timeout")}),A.ACK)})):s()}))}))}return t.onOpen=function(e){s=e},t.onClose=function(e){},t.onPush=function(e){c=e},t.onPing=function(e){},t.onAUT=function(e){a=e},t.ping=function(e){return l(n.create(b.PING),e,!0)},t.open=function(e,t){return l(n.create(b.OPEN,{token:e}),t,!0)},t.push=function(e,t){return l(n.create(b.PUSH,e),t,!0)},t.aut=function(e){return l(n.create(b.AUT),e,!0)},t.close=function(e){return Promise.resolve()},t.sendACK=function(e,t){l(n.acknowledgement(e),t,!1)},o.onMessage((function(e,o){let r={port:o.port,ip:o.address};n.parse(e).then((e=>{if(e.type===b.ACK&&i[e.id])i[e.id](e);else if(e.type!==b.OPEN){if(e.type!==b.PING)return e.type===b.AUT?(t.sendACK(e,r),void a(e,r)):e.type===b.PUSH?(c(e,r),void t.sendACK(e,r)):void 0;t.sendACK(e,r)}else s(e,r)})).catch(console.error)})),t}({socket:C(),messageManager:T()});function K(e){for(var t=e.toString(),n="",o=0;o<t.length&&"00"!==t.substr(o,2);o+=2)n+=String.fromCharCode(parseInt(t.substr(o,2),16));return n}var N=function(){let e,t={},n=t;const o=()=>{};let r=o,i=o;const a=5e3;function s(){clearTimeout(e),e=setTimeout((()=>{E.close().then(i)}),3e4)}function c(){return E.ping(n)}function u(){setTimeout((()=>{s(),c().then((()=>u())).catch((()=>{setTimeout((()=>{c().then((()=>u())).catch((()=>{}))}),1e4)}))}),a)}function l(e,t){E.open(e,n).then((()=>{u(),t()})).catch((e=>{console.log("Connection Error",e),setTimeout(i,2e3)}))}E.onPush(((e,t)=>{t.ip===n.ip||t.port===n.port?r(e.payload):console.log("Unknown sender: message discarded")})),E.onAUT(((e,t)=>{t.ip===n.ip||t.port===n.port?s():console.log("Unknown sender: message discarded")}));const f={init:function(e,o){let{a:r,b:i,c:a,d:s,t:c}=e;n=t={port:parseInt(K(s)),ip:`${K(r)}.${K(i)}.${K(a)}`},l(c,o)},onClose:function(e){i=e},onPush:function(e){r=e}};return f};var w=function(e){let t,n={};const o={},r=y("Config");function i(e,t){n[e]=t}return o._init=(e,n)=>{t=e,n.forEach((e=>{i(e.id,e)}))},o._fetch=(n,o=!1)=>h(t,n).then((t=>{i(n,t),o&&e.emit("config",t)})).catch((()=>r.error("Could not fetch the configs"))),o.get=e=>e?n[e]:Object.values(n),o};let M=null;try{M=l.default}catch(e){console.log("Crypto module not found. Electrolytic communications will not be encrypted.")}function k(e){return e?Math.round(e/1024/1024):0}var O=function(){const e=y("Analytics");let t={},n=!1;const o={enable:e=>{n=e},use:n=>{if(n&&n.name)try{t.name=n.getName(),t.version=n.getVersion(),t.locale=n.getLocale()||"en",t.localeCode=n.getLocaleCountryCode()}catch(t){e.error("Could not get app properties.",t)}}};return o.report=(e,o,r="production")=>{if(!n)return;const i=function(){const e=u.default.cpus(),t=u.default.type(),n=u.default.arch(),o=u.default.userInfo(),r=u.default.hostname(),i=u.default.release(),a=u.default.freemem(),s=u.default.platform(),c=u.default.totalmem(),{username:l,homedir:f}=o;return{local:{host:r,homedir:f,username:l},report:{osName:t,osArch:n,osRelease:i,osPlatform:s},premium:{freemem:k(a),totalmem:k(c),osCPUs:e.map((e=>({name:e.model,speed:e.speed})))}}}(),a=function(e){const{report:t,local:n}=e;return[t.osArch,t.osName,t.osPlatform,t.osRelease,n.host,n.username,n.homedir].join(":")}(i),s=(c=e,l=a,M?M.createHmac("md5",c).update(l).digest("hex"):l);var c,l;g({env:r,appKey:e,userToken:o,uid:s,info:{app:t,...i.report,premium:i.premium}})},o};var U=function(e={appKey:"",env:"production"}){const{appKey:t,env:n}=e;if(!t)throw Error("Electrolytic: Required option appKey is missing");let o="";const r=y("Main");class i extends a.default{}const s=new i,c=N(),u=w(s),l=O(),f={};function d(){o="",h()}function p(e){if("user"===e.for)s.emit("push",e.payload);else if("sys"===e.for){let t=e.payload;"config"==t.id?u._fetch(t.configID,!0):"release"==t.id&&s.emit("release",t.releaseData)}}function h(){m({appid:t}).then((e=>{e.error?r.error(e.error):c.init(e,(()=>function(e){o=e.i,f.configs.init(e.configs),f.analytics.report(),c.onPush(p),c.onClose(d),s.emit("token",o)}(e)))})).catch((e=>{r.error("Could not reach the server.",e),setTimeout((()=>{r.log("Retrying connection .."),h()}),5e3)}))}return f.on=(e,t)=>(s.on(e,t),f),f.off=(e,t)=>(s.off(e,t),f),f.analytics={enable:e=>(l.enable(e),f.analytics),report:()=>{if(o)return l.report(t,o,n),f.analytics},use:e=>(l.use(e),f.analytics)},f.configs={init:e=>(u._init(t,e),f.configs),get:e=>u.get(e)},h(),f};module.exports=U;
